---
title: "Structural validity analysis"
subtitle: "How do AMP ratings between prime types correlate in influenced vs. uninfluenced trials?"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

The AMP score is traditionally calculated as the proportion of chinese characters that were preceeded by one prime type (e.g., positive images) and evaluated positively plus the proportion of chinese characters that were preceeded by the other prime type (e.g., negative images) and evaluated negatively. That is, it assumes that the two prime categories are of opposite valence in order to produce a strong effect. 

As such, evaluations of stimuli preceeded by the positive vs negative primes should be negatively correlated: where one evaluates one positively, one should evaluate the other negatively. 

Where the analyses thus far have examined the impact of influence-awareness on the AMP effect (evaluating the implicitness of the task), or on whether influence-aware vs unaware trials have greater predcitive utility (evaluating the validity of each trial type), this set of analyses evaluates the structural validity of aware vs unaware trials. That is, not merely whether the trials are implicit or usefully predictive, but what they measure at all and how well. 

Negative correlations are required for structural valdiity in the AMP. Negative correlations are found only for the influence-aware trials. 

This suggests that unaware trials are not merely non-implicit, but not a strong or structurally valid measure of (implicit or explciit) evaluations at all. 

```{r include=FALSE}

knitr::opts_chunk$set(message = FALSE, 
                      warning = FALSE)

```

```{r setup, message=FALSE, warning=FALSE}

# dependencies
library(tidyverse)
library(broom)
library(timesavers)  # for round_df()
library(knitr)
library(kableExtra)
library(lme4)
library(sjPlot)
library(effects)

```

# Within participant analyses

Correlation between ratings of stimuli by prime type between influenced and non-influenced trials

I.e., correlations within the IA-AMP, using its trial level data.

## Data

```{r}

# get data 
data_ratings_1 <- read.csv("../Experiment 1/data/processed/trial_level_ia_amp_positive_negative_data.csv") %>%
  mutate(influenced = as.numeric(influenced)) %>%
  filter(self_exclusion_1 == "Yes, use my data" & complete_data == TRUE) %>%
  dplyr::group_by(subject, influenced, prime_type) %>%
  dplyr::summarize(mean_rating = mean(rating, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(influenced = dplyr::recode(influenced,
                                           "0" = "Non influence aware",
                                           "1" = "Influence aware")) %>%
  spread(prime_type, mean_rating) %>%
  mutate(experiment = 1, 
         domain = "posneg")

data_ratings_2 <- read.csv("../Experiment 2/data/processed/trial_level_ia_amp_positive_negative_data.csv") %>%
  mutate(influenced = as.numeric(influenced)) %>%
  filter(self_exclusion_1 == "Yes, use my data" & complete_data == TRUE) %>%
  dplyr::group_by(subject, influenced, prime_type) %>%
  dplyr::summarize(mean_rating = mean(rating, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(influenced = dplyr::recode(influenced,
                                           "0" = "Non influence aware",
                                           "1" = "Influence aware")) %>%
  spread(prime_type, mean_rating) %>%
  mutate(experiment = 2, 
         domain = "posneg")

data_ratings_3 <- read.csv("../Experiment 3/data/processed/trial_level_ia_amp_positive_negative_data.csv") %>%
  mutate(influenced = as.numeric(influenced)) %>%
  filter(self_exclusion_1 == "Yes, use my data" & complete_data == TRUE) %>%
  dplyr::group_by(subject, influenced, prime_type) %>%
  dplyr::summarize(mean_rating = mean(rating, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(influenced = dplyr::recode(influenced,
                                           "0" = "Non influence aware",
                                           "1" = "Influence aware")) %>%
  spread(prime_type, mean_rating) %>%
  mutate(experiment = 3, 
         domain = "posneg")

data_ratings_4 <- read.csv("../Experiment 4/data/processed/trial_level_ia_amp_positive_negative_data.csv") %>%
  mutate(influenced = as.numeric(influenced)) %>%
  filter(self_exclusion_1 == "Yes, use my data" & complete_data == TRUE) %>%
  dplyr::group_by(subject, influenced, prime_type) %>%
  dplyr::summarize(mean_rating = mean(rating, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(influenced = dplyr::recode(influenced,
                                           "0" = "Non influence aware",
                                           "1" = "Influence aware")) %>%
  spread(prime_type, mean_rating) %>%
  mutate(experiment = 4, 
         domain = "posneg")

data_ratings_4_b <- read.csv("../Experiment 4/data/processed/trial_level_ia_amp_obama_trump_data.csv") %>%
  mutate(influenced = as.numeric(influenced)) %>%
  filter(self_exclusion_1 == "Yes, use my data" & complete_data == TRUE) %>%
  dplyr::group_by(subject, influenced, prime_type) %>%
  dplyr::summarize(mean_rating = mean(rating, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(influenced = dplyr::recode(influenced,
                                           "0" = "Non influence aware",
                                           "1" = "Influence aware")) %>%
  spread(prime_type, mean_rating) %>%
  mutate(experiment = 4, 
         domain = "politics")

data_ratings_5 <- read.csv("../Experiment 5/data/processed/trial_level_ia_amp_positive_negative_data.csv") %>%
  mutate(influenced = as.numeric(influenced)) %>%
  filter(self_exclusion_1 == "Yes, use my data" & complete_data == TRUE) %>%
  dplyr::group_by(subject, influenced, prime_type) %>%
  dplyr::summarize(mean_rating = mean(rating, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(influenced = dplyr::recode(influenced,
                                           "0" = "Non influence aware",
                                           "1" = "Influence aware")) %>%
  spread(prime_type, mean_rating) %>%
  mutate(experiment = 5, 
         domain = "posneg")


# combine data
data_ratings <- bind_rows(data_ratings_1, 
                          data_ratings_2,
                          data_ratings_3,
                          data_ratings_4,
                          data_ratings_4_b,
                          data_ratings_5) %>%
  mutate(influenced = as.factor(influenced))

```

## Model

```{r fig.height=5, fig.width=6.5}

# fit model
fit_meta <- lmer(prime_type_B ~ prime_type_A * influenced + (1 | experiment) + (1 | domain), 
                 data = data_ratings)

# plot
plot_meta <- plot_model(fit_meta, type = "int")

plot_meta +
  xlab("Evaluation of stimuil\npreceeded by prime type A") +
  ylab("Evaluation of stimuil\npreceeded by prime type B") +
  theme_classic() + 
  labs(colour = "Influence-awareness") +
  scale_color_viridis_d(begin = 0.3, end = 0.7) +
  scale_fill_viridis_d(begin = 0.3, end = 0.7) +
  ggtitle("")

# table
tab_model(fit_meta, 
          show.std = TRUE, 
          emph.p = FALSE, 
          digits.p = 52)

```

Findings: 

- Correlations between the evaluations of stimuli preceeded by prime type A vs B are expected to be negative. 
- However, negative correlations are only found for influenced trials. 
- Positive correlations are found for uninfluenced trials. 
- Responses on influenced trials therefore show evidence of evaluation of the prime stimuli. Traditionally this would be referred to as misattribution of valence of the prime to the target, however, given that the evaluation was done in the context of awareness of influenced, it is more appropriate to say that the primes were evaluated.
- Responses on uninfluenced trials therefore show no evidence of evaluation of influence of the prime stimuli. Evidence for misatribution would require that the evaluations of the two trial types are negatively correlated in the absence of influence-awareness.

# Between participants analyses

Correlation between ratings of stimuli by prime type between high and low influence-aware groups 

I.e., correlations within the AMP, using a median split on participant level influence-awareness rate from the IA-AMP.

## Data

```{r}

data_influence_rate_2 <- read.csv("../experiment 2/data/processed/processed_data.csv") %>%
  dplyr::select(subject, influence_rate, self_exclusion_1, complete_data) %>%
  mutate(experiment = 2,
         id = paste(subject, experiment, sep = "_"))

data_influence_rate_3 <- read.csv("../experiment 3/data/processed/processed_data.csv") %>%
  dplyr::select(subject, influence_rate, self_exclusion_1, complete_data) %>%
  mutate(experiment = 3,
         id = paste(subject, experiment, sep = "_"))

data_influence_rate_5 <- read.csv("../experiment 5/data/processed/processed_data.csv") %>%
  dplyr::select(subject, influence_rate, self_exclusion_1, complete_data) %>%
  mutate(experiment = 2,
         id = paste(subject, experiment, sep = "_"))

data_influence_combined <- bind_rows(data_influence_rate_2,
                                     data_influence_rate_3,
                                     data_influence_rate_5) %>%
  dplyr::mutate(median_influence_rate = median(influence_rate, na.rm = TRUE),
                influence_rate_group = ifelse(influence_rate > median_influence_rate, "high", "low")) %>%
  select(id, influence_rate_group, influence_rate)


# get data 
data_amp_ratings_2 <- read.csv("../Experiment 2/data/processed/trial_level_ia_amp_positive_negative_data.csv") %>%
  mutate(influenced = as.numeric(influenced)) %>%
  filter(self_exclusion_1 == "Yes, use my data" & complete_data == TRUE) %>%
  dplyr::group_by(subject, prime_type) %>%
  dplyr::summarize(mean_rating = mean(rating, na.rm = TRUE)) %>%
  ungroup() %>%
  spread(prime_type, mean_rating) %>%
  mutate(experiment = 2,
         id = paste(subject, experiment, sep = "_"),
         domain = "congruent - posneg")

data_amp_ratings_3 <- read.csv("../Experiment 3/data/processed/trial_level_ia_amp_positive_negative_data.csv") %>%
  mutate(influenced = as.numeric(influenced)) %>%
  filter(self_exclusion_1 == "Yes, use my data" & complete_data == TRUE) %>%
  dplyr::group_by(subject, prime_type) %>%
  dplyr::summarize(mean_rating = mean(rating, na.rm = TRUE)) %>%
  ungroup() %>%
  spread(prime_type, mean_rating) %>%
  mutate(experiment = 3, 
         id = paste(subject, experiment, sep = "_"),
         domain = "incongruent - politics vs posneg")

data_amp_ratings_5 <- read.csv("../Experiment 5/data/processed/trial_level_ia_amp_positive_negative_data.csv") %>%
  mutate(influenced = as.numeric(influenced)) %>%
  filter(self_exclusion_1 == "Yes, use my data" & complete_data == TRUE) %>%
  dplyr::group_by(subject, prime_type) %>%
  dplyr::summarize(mean_rating = mean(rating, na.rm = TRUE)) %>%
  ungroup() %>%
  spread(prime_type, mean_rating) %>%
  mutate(experiment = 5, 
         id = paste(subject, experiment, sep = "_"),
         domain = "congruent - posneg")


# combine data
data_amp_ratings <- bind_rows(data_amp_ratings_2,
                          data_amp_ratings_3,
                          data_amp_ratings_5) %>%
  left_join(data_influence_combined, by = "id")

```

## Model

```{r fig.height=5, fig.width=6.5}

# fit model
fit_meta_amp <- lmer(prime_type_B ~ prime_type_A * influence_rate + (1 | experiment) + (1 | domain), 
                     data = data_amp_ratings)

# plot
predicted_amp <- 
  as.data.frame(effect("prime_type_A:influence_rate", fit_meta_amp, xlevels = 101)) 

ggplot(data = predicted_amp,
       aes(x = prime_type_A, y = fit, colour = influence_rate, group = influence_rate)) +
  geom_line() +
  xlab("AMP evaluations of stimuil\npreceeded by prime type A") +
  ylab("AMP evaluations of stimuil\npreceeded by prime type B") +
  scale_colour_viridis_c(direction = -1) +
  theme_classic() + 
  labs(colour = "Influence-awareness\nrate on IA-AMP")

# table
tab_model(fit_meta_amp, 
          show.std = TRUE, 
          emph.p = FALSE, 
          digits.p = 8)

```

## Define tipping point for negative correlations

Values for the influence rate tipping point were manually explored to find the value at which the correlations between evaluations of the two prime types begin to be negative.

```{r}

# plot
predicted_amp <- 
  as.data.frame(effect("prime_type_A:influence_rate", 
                       fit_meta_amp, 
                       xlevels=list(influence_rate=c(.10, .66, .90), 
                                    prime_type_A=c(.1, .2, .3, .4, .5, .6, .7, .8, .9))))

ggplot(data = predicted_amp,
       aes(x = prime_type_A, y = fit, colour = as.factor(influence_rate), group = as.factor(influence_rate))) +
  geom_line() +
  xlab("AMP evaluations of stimuil\npreceeded by prime type A") +
  ylab("AMP evaluations of stimuil\npreceeded by prime type B") +
  scale_colour_viridis_d(direction = -1) +
  theme_classic() + 
  labs(colour = "Influence-awareness\nrate on IA-AMP")

```

Tipping point was found to be influence awareness rates > 66%.

## What % of sample is above this tipping point 

I.e., in what % of participants does the AMP demonstrate this aspect of construct validity. 

```{r}

# get meta analysis combined data
combined_participant_level_data <- read.csv("../meta analysis/data/combined_participant_level_data.csv") 

tipping_point <- 0.66

percent_of_participants <- combined_participant_level_data %>%
  mutate(influence_rate_above_tipping_point = ifelse(influence_rate > tipping_point, TRUE, FALSE)) %>%
  dplyr::summarize(percent_of_participants_with_influence_rate_above_tipping_point = 100 - sum(influence_rate_above_tipping_point)/n()*100) %>%
  round_df(1) %>%
  pull(percent_of_participants_with_influence_rate_above_tipping_point)

```

Percent of participants with influence rates below the tipping point, for whom the AMP does not demonstrate structural validity = `r percent_of_participants`%.


