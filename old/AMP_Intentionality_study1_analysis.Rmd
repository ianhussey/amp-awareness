
Notes:

I know it's just a work in progress, but some feedback that might be irrelevant ofc. Many of your variable names/workflow could have more descriptive names. Try to call data frames as things rather than things that do stuff: e.g., "joiner" implies it does something and cues that it's a function rather than a dataframe. If it's a data frame for H1, try data_h1, etc. Just one or two comments about what a block does can work magic for helping others understand what sth does. e.g. "# reshapes the data into long format", "# trim data for analysis in H1", etc. :)
whether using RMarkdown or not, code chunks can help this as you can collapse them at the linenumbers. e.g., a comment of "# ----------------" with more than (i think) 5X #s makes that chunk collapseable. When using markdown, levels of heading help organise too, and you can use the table of contents to move around the script. egs below

I've added some bayesian analyses, and a plot that adds marginal plots to give a sense of the skewed distribition of influence ratings. 

```{r}

library(plyr)
library(tidyverse)
library(data.table)
library(lme4)
library(sjPlot)
library(effects)
library(brms)
library(TOSTER)
library(DescTools)
library(Rmisc)
library(effsize)
library(psych)

```


```{r}

# setwd("demographics/")
# files <- list.files(pattern = ".csv$") 
# demographics_df <- tbl_df(rbind.fill(lapply(files, fread, header=TRUE))) 
# 
# write_csv(demographics_df, "demographics.csv")

demographics_df <- read.csv("demographics.csv")

```

```{r}

# setwd("amp")
# files1 <- list.files(pattern = ".csv$") 
# AMP_df <- tbl_df(rbind.fill(lapply(files1, fread, header=TRUE))) 
# 
# write_csv(AMP_df, "AMP.csv")

AMP_df <- read.csv("AMP.csv")

```

```{r}

# setwd("questions")
# files2 <- list.files(pattern = ".csv$") 
# post_df <- tbl_df(rbind.fill(lapply(files2, fread, header=TRUE))) 
# 
# write_csv(post_df, "post_questions.csv")

post_df <- read.csv("post_questions.csv")

```

```{r}

# Use this df to screen for subjects who didn't give a Prolific ID
prolificid_df <- demographics_df %>%
  distinct(subject, trialcode, .keep_all = TRUE) %>%
  filter(trialcode == "ProlificCode") %>%
  dplyr::select(subject, response) 

# Screen questions df for unique values, remove duplicates
self_exclusion <- post_df %>%
  dplyr::distinct(subject, trialcode, .keep_all = TRUE) %>%
  dplyr::select(subject, trialcode, response)

# Join the above two dfs, filter for only the appropriate number of rows
screen <- full_join(prolificid_df, self_exclusion, by="subject") %>%
  group_by(subject) %>% 
  filter(n() == 6) %>%
  dplyr::rename(prolificid = response.x, response = response.y) %>%
  mutate(response = as.character(response))

# recode post_df responses, remove NAs
questions <- post_df %>%
  mutate(response = as.character(response),
         response = ifelse(response == "none" | response == "Never", 1, 
                           ifelse(response == "a few" | response == "Very rarely", 2, 
                                  ifelse(response == "less than half" | response == "Somewhat rarely", 3,
                                         ifelse(response == "about half" | response == "Sometimes", 4,
                                                ifelse(response == "more than half", 5, 
                                                       ifelse(response == "most", 6,
                                                              ifelse(response == "all", 7, response)))))))) %>%
  na.omit() 

screen_qs <- questions %>%
  distinct(subject, trialcode, .keep_all = TRUE) %>%
  dplyr::select(subject, trialcode, response) %>%
  group_by(subject) %>%
  spread(trialcode, response) %>%
  na.omit()

```


```{r}
  
# Leaded df so that "influenced" refers to whether the trial response 
# indicated the absence (0) or presence (1) of an influence of the prime
# Also filters incomplete AMP data
AMP_lead <- AMP_df %>%
  mutate(influenced = ifelse(trialcode == "intention_check" & correct == 1, 1, 0),
         influenced = lead(influenced)) %>%
  filter(trialcode == "prime_positive" | trialcode == "prime_negative") %>%
  mutate(trialcode = ifelse(trialcode == "prime_positive", 1, 0)) %>%
  group_by(subject) %>% 
  filter(n() == 120) %>%
  ungroup() %>% ## IAN: missing this, needed later
  semi_join(., screen, by = "subject") %>%
  semi_join(., screen_qs, by = "subject")

# rescale variables
AMP_rescaled <- AMP_lead %>%
  mutate(influenced = influenced - .5,  # IAN: jamie, you effect coded this and then changed to factor, only one is needed
         trialcode = trialcode - .5,
         correct = as.numeric(as.character(correct))) ## Ian: had to add this

AMP_influenced <- AMP_rescaled %>%
  dplyr::filter(influenced == .5)

AMP_uninfluenced <- AMP_rescaled %>%
  dplyr::filter(influenced == -.5)

#### need to filter for 120 trials in AMP ####
#### need to figure out how to get pooled sd for recentering ####

```


```{r}

##### Confirmatory analyses ##### 

# Extra dfs for subject-level analyses
joiner <- AMP_rescaled %>%
  group_by(subject, trialcode) %>%
  dplyr::summarize(amp_effect = mean(correct)) %>%
  ungroup() %>%
  spread(trialcode, amp_effect) %>%
  setnames(., c("-0.5", "0.5"), c("false_prime", "true_prime")) %>%
  mutate(amp_effect = true_prime - false_prime)

joiner_uninfl <- AMP_rescaled %>%
  filter(influenced == -.5) %>%
  group_by(subject, trialcode) %>%
  dplyr::summarize(amp_effect = mean(correct)) %>%
  ungroup() %>%
  spread(trialcode, amp_effect) %>%
  setnames(., c("-0.5", "0.5"), c("false_prime", "true_prime")) %>%
  mutate(amp_effect = true_prime - false_prime)

joiner_infl <- AMP_rescaled %>%
  filter(influenced == .5) %>%
  group_by(subject, trialcode) %>%
  dplyr::summarize(amp_effect = mean(correct)) %>%
  ungroup() %>%
  spread(trialcode, amp_effect) %>%
  setnames(., c("-0.5", "0.5"), c("false_prime", "true_prime")) %>%
  mutate(amp_effect = true_prime - false_prime)

subjects_df <- AMP_rescaled %>%
  mutate(influenced = as.numeric(as.character(influenced))) %>%
  group_by(subject) %>%
  dplyr::summarize(influence_rate = mean(influenced)) %>%
  ungroup() %>%
  left_join(joiner, by = "subject") %>%
  left_join(screen_qs, by = "subject") %>%
  mutate(influence_rate = as.numeric(influence_rate)) %>%
  mutate(influence_general = as.numeric(influence_general)) %>%
  mutate(intentionality = as.numeric(intentionality)) %>%
  mutate(unintentionality = as.numeric(unintentionality)) %>%
  na.omit(.)


quick_look <- AMP_rescaled %>%
  mutate(influenced = as.numeric(as.character(influenced))) %>%
  group_by(subject) %>%
  dplyr::summarize(influence_rate = mean(influenced)) %>%
  ungroup() %>%
  left_join(joiner_uninfl, by = "subject") %>%
  left_join(screen_qs, by = "subject") %>%
  mutate(influence_rate = as.numeric(influence_rate),
         influence_general = as.numeric(influence_general),
         amp_effect = as.numeric(amp_effect)) %>%
  na.omit()
  
quick_look %>%
  summarize(sd = sd(amp_effect))

quick_look2 <- AMP_rescaled %>%
  mutate(influenced = as.numeric(as.character(influenced))) %>%
  group_by(subject) %>%
  dplyr::summarize(influence_rate = mean(influenced)) %>%
  ungroup() %>%
  left_join(joiner_infl, by = "subject") %>%
  left_join(screen_qs, by = "subject") %>%
  mutate(influence_rate = as.numeric(influence_rate)) %>%
  mutate(influence_general = as.numeric(influence_general)) %>%
  na.omit(.)

```

# M1

```{r}

#M1: standard AMP effect
t.test(subjects_df$true_prime, subjects_df$false_prime, paired = TRUE)
t.test(quick_look$true_prime, quick_look$false_prime, paired = TRUE)
t.test(quick_look2$true_prime, quick_look2$false_prime, paired = TRUE)


model_m1 <- glmer(correct ~ trialcode + (1|subject), 
                  data = AMP_rescaled, 
                  family = binomial(link = "logit"))
#sjp.glmer(model_m1, type = "pred", vars = c("correct"))
sjt.glmer(model_m1)

```

## bayesian on subject level data

```{r}

library(brms)

# presence of an amp effect

fit_m1_bayesian <- brm(amp_effect ~ 1,
                       data = subjects_df,
                       file = "m1")

summary(fit_m1_bayesian)

M1 <- fit_m1_bayesian %>% hypothesis("Intercept > 0", alpha = .05)
#plot(M1)
colMeans(M1$samples > 0) %>% round(5)



# difference in amp effect by influnce ratings

amp_effect_by_influence <- AMP_rescaled %>%
  group_by(subject, trialcode, influenced) %>%
  dplyr::summarize(amp_effect = mean(correct)) %>%
  ungroup() %>%
  spread(trialcode, amp_effect) %>%
  rename(false_prime = "-0.5", 
         true_prime = "0.5") %>%
  mutate(amp_effect = true_prime - false_prime)


fit_t1_bayesian <- brm(amp_effect ~ influenced,
                       data = amp_effect_by_influence,
                       file = "t1")

summary(fit_t1_bayesian)

t1 <- fit_t1_bayesian %>% hypothesis("influenced > 0", alpha = .05)
#plot(M1)
colMeans(t1$samples > 0) %>% round(5)


```

# H1

```{r}

# M1&H1: report of influence and correct ~ trialcode moderation
model_m1h1 <- glmer(correct ~ influenced * trialcode + (1|subject), 
                    data = AMP_rescaled, 
                    family = binomial(link = "logit"))
#sjp.glmer(model_m1h1, type = "pred", vars = c("correct", "influenced"))
sjt.glmer(model_m1h1, digits.p = 20)

```

# H1b

```{r}

# M1 Split by influenced or uninfluenced
model_infl <- glmer(correct ~ trialcode + (1|subject), 
                    data = AMP_influenced, 
                    family = binomial(link = "logit"))
#sjp.glmer(model_infl, type = "pred", vars = c("correct", "trialcode"))
sjt.glmer(model_infl)

```

# H1c

```{r}

model_uninfl <- glmer(correct ~ trialcode + (1|subject), data = AMP_uninfluenced, family = binomial(link = "logit"))
#sjp.glmer(model_uninfl, type = "pred", vars = c("correct", "trialcode"))
sjt.glmer(model_uninfl)

```

# H2

```{r}

# H2: AMP effect moderated by proportion influenced
fit_h2 <- lm(amp_effect ~ influence_rate, data = subjects_df)
sjp.lm(fit_h2)
sjt.lm(fit_h2, show.std = TRUE, digits.p = 15)

```

```{r}

# plot

p <- ggplot(subjects_df, aes(influence_rate, amp_effect)) +
  geom_jitter(alpha = 0.3) +
  geom_smooth(method = "lm") +
  geom_rug(position = "jitter", alpha = 0.3) +
  theme_classic()

p

# only prints when not run in RMarkdown:
ggMarginal(p, type = "density", margins = "both")

```


## bayesian

```{r}

# difference in amp effect by proportion of trials influenced

fit_h2_bayesian <- brm(amp_effect ~ influence_rate,
                       data = subjects_df,
                       file = "h2")

summary(fit_h2_bayesian)

H2 <- fit_h2_bayesian %>% hypothesis("influence_rate > 0", alpha = .05)
#plot(H2)
colMeans(H2$samples > 0) %>% round(5)

```

# H3

```{r}

#H3: regression between influences
fit_h3 <- lm(influence_rate ~ influence_general, data = subjects_df)
ggplot(data = subjects_df, aes(x = influence_general, y = influence_rate)) +
  geom_point() 
summary(fit_h3)

```

# H3a

```{r}

fit_int1 <- lm(influence_rate ~ intentionality, data = subjects_df)
ggplot(data = subjects_df, aes(x = intentionality, y = influence_rate)) +
  geom_point() 
summary(fit_int1)

```

# H3b

```{r}

fit_unint1 <- lm(influence_rate ~ unintentionality, data = subjects_df)
ggplot(data = subjects_df, aes(x = unintentionality, y = influence_rate)) +
  geom_point() 
summary(fit_unint1)

```

# H4

```{r}

# H4: regression of influences on AMP effect
fit_h4 <- lm(amp_effect ~ influence_general + influence_rate, data = subjects_df)
sjp.lm(fit_h4)
sjt.lm(fit_h4, show.std = TRUE)


# Look at distribution of influenced/noninfluenced
t <- AMP_lead %>%
  filter(influenced == 1) %>%
  dplyr::count(subject, influenced) %>%
  arrange(n)

# Equivalence test from zero for uninfluenced trials
TOSTone(0.117877, 0, .285, 137, -.3, .3, .05, plot = TRUE)

effsize::cohen.d(quick_look$true_prime, quick_look$false_prime)
effsize::cohen.d(subjects_df$true_prime, subjects_df$false_prime)
effsize::cohen.d(quick_look2$true_prime, quick_look2$false_prime)


```

# Es

```{r}

# Cronbach's alpha reshaping
gen_amp <- AMP_lead %>%
  select(subject, trialnum, correct) %>%
  mutate(correct = as.numeric(correct)) %>%
  spread(trialnum, correct) %>%
  select(-subject)

inf_amp <- AMP_influenced %>%
  select(subject, trialnum, correct) %>%
  spread(trialnum, correct) %>%
  select(-subject)

uninf_amp <- AMP_uninfluenced %>%
  select(subject, trialnum, correct) %>%
  mutate(correct = as.numeric(correct)) %>%
  spread(trialnum, correct) %>%
  select(-subject)

alpha_gen_amp <- psych::alpha(gen_amp)
alpha_gen_amp$total$raw_alpha

alpha_inf_amp <- psych::alpha(inf_amp)
alpha_inf_amp$total$raw_alpha

alpha_uninf_amp <- psych::alpha(uninf_amp)
alpha_uninf_amp$total$raw_alpha

```