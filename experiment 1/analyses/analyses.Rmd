---
title: "Study 1"
subtitle: "Analyses"
author: "Ian Hussey & Jamie Cummins"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r include=FALSE}

knitr::opts_chunk$set(message = FALSE, 
                      warning = FALSE)

```

```{r setup, message=FALSE, warning=FALSE}

# dependencies
library(tidyverse)
library(lme4)
library(sjPlot)
library(effects)
library(DescTools)
library(Rmisc)
library(effsize)
library(psych)
library(broom)
library(kableExtra)
# devtools::install_github("ianhussey/timesavers")
library(timesavers)  # for round_df()

# get data 
task_level_data <- read.csv("../data/processed/processed_data.csv")

trial_level_ia_amp_data <- read.csv("../data/processed/trial_level_ia_amp_positive_negative_data.csv") %>%
  mutate(influenced = as.numeric(influenced))

# exclusions
task_level_data_exclusions <- task_level_data %>%
  filter(self_exclusion_1 == "Yes, use my data" & complete_data == TRUE)

trial_level_ia_amp_data_exclusions <- trial_level_ia_amp_data %>%
  filter(self_exclusion_1 == "Yes, use my data" & complete_data == TRUE)

```

# Demographics

Analytic sample after exclusions.

```{r age and gender}

# Gender
task_level_data_exclusions %>%
  mutate(gender = tolower(gender)) %>%
  dplyr::count(gender)

# Age mean and SD
task_level_data_exclusions %>%
  mutate(age = as.numeric(as.character(age))) %>%
  summarise("age (mean)" = mean(age), "age (standard deviation)" = sd(age)) %>%
  round_df(2)

```

# Manipulation checks

## Descriptives - Asked for inclusion by Reviewer 1

```{r}

# overall IA-AMP effect size
task_level_data_exclusions %>%
  select(subject, IA_AMP_effect_positive_negative, AMP_effect_positive_negative) %>%
  summarise(amp_effect = mean(AMP_effect_positive_negative),
            amp_sd = sd(AMP_effect_positive_negative),
            ia_amp_effect = mean(IA_AMP_effect_positive_negative),
            ia_amp_sd = sd(IA_AMP_effect_positive_negative))

# specific effects
trial_level_ia_amp_data_exclusions %>%
  group_by(subject, prime_type, influenced) %>%
  dplyr::summarise(mean_rating = mean(rating)) %>%
  spread(prime_type, mean_rating) %>%
  mutate(prime_type_A = ifelse(is.na(prime_type_A), .5, prime_type_A),
         prime_type_B = ifelse(is.na(prime_type_B), .5, prime_type_B)) %>%
  mutate(amp_effect = prime_type_B - prime_type_A) %>%
  select(subject, influenced, amp_effect) %>%
  spread(influenced, amp_effect) %>%
  mutate(`0` = ifelse(is.na(`0`), 0, `0`),
         `1` = ifelse(is.na(`1`), 0, `1`)) %>%
  summarise(mean_uninfluenced = mean(`0`),
            sd_uninfluenced = sd(`0`),
            mean_influenced = mean(`1`),
            sd_influenced = sd(`1`))

# How many influence-aware trials?
trial_level_ia_amp_data_exclusions %>%
  dplyr::count(subject, influenced) %>%
  spread(influenced, n) %>%
  mutate(`0` = ifelse(is.na(`0`), 0, `0`),
         `1` = ifelse(is.na(`1`), 0, `1`)) %>%
  summarise(mean_influenced = mean(`1`),
            sd = sd(`1`))
  
  

```

## M1: Demonstate an AMP effect on the IA AMP

```{r}

# fit model
model_m1 <- glmer(rating ~ prime_type + (1 | subject), 
                  family = binomial(link = "logit"),
                  data = trial_level_ia_amp_data_exclusions)

# plot
plot_model(model_m1, type = "pred", terms = c("prime_type"))

# results table
tab_model(model_m1, emph.p = FALSE, ci.hyphen = ", ")

# extract OR and convert to d using the method proposed by Hasselblad & Hedges (1995, Equation 5, p. 170): d = log(OR)*(sqrt(3)/pi). See also Sánchez-Meca, Marín-Martínez & Chacón-Moscoso's (2003).
coefficients_temp <- summary(model_m1)$coefficients %>%
  as.data.frame() %>%
  rownames_to_column(var = "effect") %>%
  filter(effect == "prime_typeprime_type_B")

m1_d <- c(exp(pull(coefficients_temp, Estimate)), 
           exp(pull(coefficients_temp, Estimate) - pull(coefficients_temp, "Std. Error")*1.96),
           exp(pull(coefficients_temp, Estimate) + pull(coefficients_temp, "Std. Error")*1.96)) %>%
  timesavers::OR_to_d(.) %>%
  round(2)

```

OR converted to Cohen's d for familiarity: d = `r m1_d[1]`, 95% CI [`r m1_d[2]`, `r m1_d[3]`].

# Hypothesis tests

## H1: IA-AMP influence rate predicts IA-AMP effect

### H1a: at the trial level

Does conscious awareness of influence of the prime on the target moderate the AMP effect?

Key effect: influence*prime_type interaction

```{r}

# model
model_h1a <- glmer(rating ~ influenced * prime_type + (1 | subject), 
                   family = binomial(link = "logit"),
                   data = trial_level_ia_amp_data_exclusions)

# plot
plot_model(model_h1a, type = "pred", terms = c("influenced", "prime_type"))

# results table
tab_model(model_h1a, emph.p = FALSE, ci.hyphen = ", ")

# extract OR and convert to d using the method proposed by Hasselblad & Hedges (1995, Equation 5, p. 170): d = log(OR)*(sqrt(3)/pi). See also Sánchez-Meca, Marín-Martínez & Chacón-Moscoso's (2003).
coefficients_temp <- summary(model_h1a)$coefficients %>%
  as.data.frame() %>%
  rownames_to_column(var = "effect") %>%
  filter(effect == "influenced:prime_typeprime_type_B")

h1a_d <- c(exp(pull(coefficients_temp, Estimate)), 
           exp(pull(coefficients_temp, Estimate) - pull(coefficients_temp, "Std. Error")*1.96),
           exp(pull(coefficients_temp, Estimate) + pull(coefficients_temp, "Std. Error")*1.96)) %>%
  timesavers::OR_to_d(.) %>%
  round(2)

```

OR converted to Cohen's d for familiarity: d = `r h1a_d[1]`, 95% CI [`r h1a_d[2]`, `r h1a_d[3]`].

### H1b: at the participant level

Does rate of influence in the IA-AMP predict IA-AMP effects?

If effects in the IA-AMP are driven by intentional responding, then the size of the effect in the IA-AMP should be moderated by the subset of participants who are more often influenced by the primes. 

```{r}

# model
fit_h1b <- task_level_data_exclusions %>%
  mutate(abs_IA_AMP_effect_positive_negative = abs(IA_AMP_effect_positive_negative)) %>%
  lm(abs_IA_AMP_effect_positive_negative ~ influence_rate, data = .)

# plot
ggplot(task_level_data_exclusions, aes(influence_rate, abs(IA_AMP_effect_positive_negative))) + 
  geom_jitter(alpha = 0.3) +
  geom_rug(position = "jitter") +
  geom_smooth(method = lm) +
  labs(title = "Proportion of influenced trials and IA-AMP effect", 
       x = "Proportion of influenced trials", 
       y = "IA-AMP effect") +
  theme_classic()

# results table
tab_model(fit_h1b, emph.p = FALSE, ci.hyphen = ", ", show.std = TRUE)

```

## H2: Correlation between online and offline measures of influence

Do the online measure of influence (i.e., pressing the spacebar after trials) correlate with typically-used offline measures of influence (i.e., the self-reports following completion of the task regarding how frequently the participant felt that they were influenced)?

```{r}

# model
fit_h2 <- lm(influence_rate ~ influence_general, data = task_level_data_exclusions)

# Plot
ggplot(data = task_level_data_exclusions, aes(x = influence_general, y = influence_rate)) +
  geom_jitter(alpha = 0.3) +
  geom_smooth(method = lm) +
  geom_rug(position = "jitter") +
  labs(x = "Offline influence (self report)", y = "Online influence (IA-AMP)") +
  theme_classic()

# results table
tab_model(fit_h2, show.std = TRUE, emph.p = FALSE, ci.hyphen = ", ")

```

## H3: Contribution of offline and online measures in predicting AMP effect sizes

Do the online measure of influence, the offline measure of influence, or both, predict AMP effect sizes?

```{r}

# model
fit_h3 <- lm(IA_AMP_effect_positive_negative ~ influence_general + influence_rate, 
             data = task_level_data_exclusions)

# plot
plot_model(fit_h3, type = "pred", terms = c("influence_rate"))
plot_model(fit_h3, type = "pred", terms = c("influence_general"))

# results table
tab_model(fit_h3, show.std = TRUE, emph.p = FALSE, ci.hyphen = ", ")

```

