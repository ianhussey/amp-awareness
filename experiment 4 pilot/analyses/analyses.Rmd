---
title: "Study 4: Pilot"
subtitle: "Analyses"
author: "Jamie Cummins & Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

Ian: I've updated H4 and H5. M1-M2, H1-H3 still to be reviewed.

```{r include=FALSE}

knitr::opts_chunk$set(message = FALSE, 
                      warning = FALSE)

```

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}

# dependencies
library(tidyverse)
library(lme4)
library(sjPlot)
library(bootES)
library(car)
library(broom)
library(timesavers) # from github.com/ianhussey/timesavers
library(psych)
#library(effects)
#library(broom)
#library(kableExtra)

# disable scientific notation
options(scipen = 999)

# get data
processed_data <- read.csv("../data/processed/processed_data.csv") 

analysis_data <- processed_data %>%
  filter(complete_data == TRUE & 
           self_exclusion_1 == "Yes, use my data" & 
           party %in% c("democrat", "republican"))

```

# Gender and age descriptive statistics

```{r age and gender}

# Gender
processed_data %>%
  dplyr::count(gender)

# Age mean and SD
processed_data %>%
  #mutate(age = as.numeric(as.character(age))) %>%
  summarise("age (mean)" = round(mean(age, na.rm = TRUE), 2),
            "age (standard deviation)" = round(sd(age, na.rm = TRUE), 2))

```

# Manipulation checks

## M1: Demonstate an AMP effect for the standard AMP

### Logistic mixed-effects model

```{r}

# fit model
model_m1_positive_negative_amp <- glmer(correct ~ prime_type + (1|subject), 
                                        family = binomial(link = "logit"),
                                        data = normed_AMP_df)

# plot
sjp.glmer(model_m1_positive_negative_amp, type = "pred", vars = c("prime_type"))

# results table
sjt.glmer(model_m1_positive_negative_amp)

```

## M2: Demonstate an AMP effect on the modified IA-AMP

### Logistic mixed-effects model

#### Democrats

```{r}

# fit model
model_m1_pol_d <- glmer(correct ~ prime_type + (1|subject), 
                        family = binomial(link = "logit"),
                        data = democrats_df)

# plot
sjp.glmer(model_m1_pol_d, type = "pred", vars = c("prime_type"))

# results table
sjt.glmer(model_m1_pol_d)

```

#### Republicans

```{r}

# fit model
model_m1_pol_r <- glmer(correct ~ prime_type + (1|subject), 
                        family = binomial(link = "logit"),
                        data = republicans_df)

# plot
sjp.glmer(model_m1_pol_r, type = "pred", vars = c("prime_type"))

# results table
sjt.glmer(model_m1_pol_r)

```

# Hypotheses tests to replicate of effects found in previous experiments

## H1: influence moderates the IA-AMP effect (trial level)

For both IA-AMPs, the effect of prime type on response in trials is moderated by the subset of trials where influenced is reported.

Key effect: influenced*prime_type interaction

## Normed AMP 

```{r}
# model
model_h1_positive_negative_amp <- glmer(correct ~ influenced * prime_type + (1|subject), 
                                        family = binomial(link = "logit"),
                                        data = normed_AMP_df)

# plot
sjp.glmer(model_h1_positive_negative_amp, type = "pred", vars = c("prime_type", "influenced"))

# results table
sjt.glmer(model_h1_positive_negative_amp, digits.p = 20)

```

### Politics AMP 

#### Democrats

```{r}
# model
model_h1_pol_d <- glmer(correct ~ influenced * prime_type + (1|subject), 
                        family = binomial(link = "logit"),
                        data = democrats_df)

# plot
sjp.glmer(model_h1_pol_d, type = "pred", vars = c("prime_type", "influenced"))

# results table
sjt.glmer(model_h1_pol_d, digits.p = 20)

```

#### Republicans

```{r}
# model
model_h1_pol_r <- glmer(correct ~ influenced * prime_type + (1|subject), 
                        family = binomial(link = "logit"),
                        data = republicans_df)

# plot
sjp.glmer(model_h1_pol_r, type = "pred", vars = c("prime_type", "influenced"))

# results table
sjt.glmer(model_h1_pol_r, digits.p = 20)

```

## H2: IA-AMP influence rate predicts IA-AMP effect (participant level)

If effects in the IA-AMP are driven by intentional responding, then the size of the effect in the IA-AMP should be moderated by the subset of participants who are more often influenced by the primes. 
That is: rate of influence in the IA-AMP should predict IA-AMP effect sizes.

### Politics AMP

```{r}

# model
fit_h2_pol <- lm(abs(pol_amp_effect) ~ influence_rate_pol, 
                 data = analysis_data)

# plot
ggplot(analysis_data, aes(influence_rate_pol, abs(pol_amp_effect))) + 
  geom_point() +
  geom_rug(position = "jitter") +
  geom_smooth(method = lm) +
  labs(title = "Rate of influence and (absolute) IA-AMP effect size", x = "Rate of influence: Politics", y = "Politics AMP effect size") +
  theme_classic()

# table
sjt.lm(fit_h2_pol, show.std = TRUE, digits.p = 15)

```

### Positive-Negative AMP

```{r}

# model
fit_h2_norm <- lm(normed_amp_effect ~ influence_rate_norm, 
                  data = analysis_data)

# plot
ggplot(analysis_data, aes(influence_rate_norm, normed_amp_effect)) + 
  geom_point() +
  geom_rug(position = "jitter") +
  geom_smooth(method = lm) +
  labs(title = "Rate of influence and (absolute) IA-AMP effect size", x = "Rate of influence: Normed", y = "Positive-Negative AMP effect size") +
  theme_classic()

# table
sjt.lm(fit_h2_norm, show.std = TRUE, digits.p = 15)

```

## H3: One influence rate predicts the other AMP effect

If effects in the AMP in general are driven by participants who are more often influenced, and this tendency to be influenced is consistent across AMPs which vary in domain content, then rate of influence in one AMP should predict effect sizes in the other AMP, and this should be the case in both directions.

### Positive-Negative influence, politics AMP

```{r}

# model
fit_h2_np <- lm(abs(pol_amp_effect) ~ influence_rate_norm, 
                data = analysis_data)

# plot
ggplot(analysis_data, aes(influence_rate_norm, abs(pol_amp_effect))) + 
  geom_point() +
  geom_rug(position = "jitter") +
  geom_smooth(method = lm) +
  labs(title = "Rate of influence and (absolute) IA-AMP effect size", x = "Rate of influence: Normed", y = "Positive-Negative AMP effect size") +
  theme_classic()

# table
sjt.lm(fit_h2_np, show.std = TRUE, digits.p = 15)

```

### Politics influence, Positive-Negative AMP

```{r}

# model
fit_h2_pn <- lm(normed_amp_effect ~ influence_rate_pol, 
                data = analysis_data)

# plot
ggplot(analysis_data, aes(influence_rate_pol, normed_amp_effect)) + 
  geom_point() +
  geom_rug(position = "jitter") +
  geom_smooth(method = lm) +
  labs(title = "Rate of influence and (absolute) IA-AMP effect size", x = "Rate of influence: Politics", y = "Positive-Negative AMP effect size") +
  theme_classic()

# table
sjt.lm(fit_h2_pn, show.std = TRUE, digits.p = 15)

```

# Tests of novel hypotheses

## H4: Correlation of influence rates between AMPs

If propensity to be influenced the primes is a individual difference variable, then influence rates should correlate between AMPs assessing different domains.

```{r fig.height=5, fig.width=5}

# bootstrapping
influence_correlations <- analysis_data %>%
  select(influence_rate_obama_trump, influence_rate_positive_negative) %>%
  cor.ci(., 
         n.iter = 2000, 
         method = "pearson", 
         plot = FALSE)

# summarize
data.frame(pearson_r = influence_correlations$means,
           pearson_r_ci_lwr = influence_correlations$ci$low.e,
           pearson_r_ci_upr = influence_correlations$ci$up.e) %>%
  round_df(2)

# Plot
ggplot(analysis_data, aes(influence_rate_positive_negative, influence_rate_obama_trump)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_rug(position = "jitter") +
  scale_color_viridis_d() +
  labs(x = "Positive-Negative AMP", y = "Obama-Trump AMP") +
  ggtitle("Influence rates") +
  theme_classic()

```

## H5: Group differences between influenced vs. non influenced AMP trials

AMP effects differ between the groups

```{r}

h5_fit_0 <- 
  analysis_data %>% 
  select(IA_AMP_effect_obama_trump, party) %>%
  aov(IA_AMP_effect_obama_trump ~ party, 
      data = .)

Anova(h5_fit, type = "III")


h5_plot_0 <- sjp.lm(h5_fit_0, 
                    type = "eff", 
                    prnt.plot = FALSE)

h5_plot_0$data %>%
  as.data.frame() %>%
  rename("IA_AMP effect" = y,
         "Political party" = labels) %>%
  ggplot(., aes(`Political party`, `IA_AMP effect`)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high),
                  position = position_dodge(width = 0.1)) +
  geom_point(position = position_dodge(width = 0.1)) +
  theme_classic() +
  scale_colour_viridis_d(begin = .2, end = .6)

```

But these differences should be reduced when influenced and non-influenced trials are considered separately. Separate AMP effects are calculated for the subsets of influenced and non influenced trials. 

Importantly, our hypothesis here refers to a reduction in the AMP effect's utility when influence is taken into account, not necessarily its reduction to zero. The superiority of differences between groups when considering the influenced trials relative to the non-influenced trials would demonstrate the AMP effect is driven predominantly by these influenced trials. This does not speak to whether non influenced trials remain to have utility, or whether this manner of self reporting is unbiased (e.g., participants may well under report whether they are influenced or not: they are unlikely to report being influenced if they were not, but could notionally report that they were not influenced when they were were. Our metric therefore likely demonstrates better specificity than sensitivity). 

```{r message=FALSE, warning=TRUE}

h5_fit <- 
  analysis_data %>% 
  dplyr::select(IA_AMP_effect_obama_trump_influenced, 
                IA_AMP_effect_obama_trump_not_influenced, 
                party) %>%
  gather(influence, AMP_effect, c(IA_AMP_effect_obama_trump_influenced, 
                                  IA_AMP_effect_obama_trump_not_influenced)) %>%
  dplyr::mutate(influence = dplyr::recode(influence,
                                          "IA_AMP_effect_obama_trump_not_influenced" = "Not influenced",
                                          "IA_AMP_effect_obama_trump_influenced" = "Influenced"),
                influence = as.factor(influence),
                influence = fct_relevel(influence, "Not influenced", "Influenced")) %>%
  aov(AMP_effect ~ party * influence, 
      data = .)

Anova(h5_fit, type = "III") %>% 
  tidy() %>%
  dplyr::mutate(sumsq = round(sumsq, 2),
                statistic = round(statistic, 2))

h5_plot <- sjp.int(h5_fit, 
                   mdrt.values = "minmax", 
                   prnt.plot = FALSE)

h5_plot$data.list %>%
  as.data.frame() %>%
  mutate(Influence = dplyr::recode(x,
                                   "1" = "Influenced",
                                   "2" = "Not influenced"),
         Influence = as.factor(Influence),
         Influence = fct_relevel(Influence, 
                                 "Not influenced",
                                 "Influenced")) %>%
  rename("IA_AMP effect" = y,
         "Political party" = grp) %>%
  ggplot(., aes(Influence, `IA_AMP effect`, color = `Political party`, shape = `Political party`)) +
  #geom_ribbon(aes(ymin = conf.low, ymax = conf.high), linetype = 0, alpha = 0.1) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high),
                  position = position_dodge(width = 0.1)) +
  geom_point(position = position_dodge(width = 0.1)) +
  theme_classic() +
  scale_colour_viridis_d(begin = .2, end = .6) +
  xlab("Awareness of influence of prime on target")


```

To illustrate, we bootstrap Cohen's d values for the differences between the groups for each subset of trials. The CIs of each should exclude one-another; point estimate. 

```{r}

# Non influenced trials

h5_obama_trump_non_influenced <- 
  analysis_data %>% 
  select(IA_AMP_effect_obama_trump_not_influenced, party) %>%
  na.omit() %>%
  # bootES is terrible and I hate it and the people who made it, especially since they supposedly had
  # usability by R novies in mind. 
  # it has no vignettes, the likely modal use case of bootstrapping cohen's d
  # is unnecessarially hard to implement, it doesnt take formula input, 
  # and it throws uninterpretable error messages that do not help you solve the problem. 
  # All bug testing done with effsize::cohens_d before refactoring to bootES.
  # You bastards.
  bootES(data = .,
         data.col = "IA_AMP_effect_obama_trump_not_influenced", 
         group.col = "party",
         contrast = c("republican", "democrat"),  # levels must be quoted, function doesn't like numerics 
         effect.type = "cohens.d.sigma",  # cohens.d gives sample sd, adding sigma gives population sd
         ci.type = "bca",
         R = 2000,  # if "estimated adjustment 'a' is NA", increase n bootstraps 
         ci.conf = 0.95)

# summarize
cohens_d_non_influenced <- 
  data.frame(cohens_d = h5_obama_trump_non_influenced$t0,
             cohens_d_ci_lwr = h5_obama_trump_non_influenced$bounds[1],
             cohens_d_ci_upr = h5_obama_trump_non_influenced$bounds[2]) %>%
  round_df(2) %>%
  mutate(subset = "Non influenced")


# Influenced trials

h5_obama_trump_influenced <- 
  analysis_data %>% 
  select(IA_AMP_effect_obama_trump_influenced, party) %>%
  na.omit() %>%
  bootES(data = .,
         data.col = "IA_AMP_effect_obama_trump_influenced", 
         group.col = "party",
         contrast = c("republican", "democrat"),  # levels must be quoted, function doesn't like numerics 
         effect.type = "cohens.d.sigma",  # cohens.d gives sample sd, adding sigma gives population sd
         ci.type = "bca",
         R = 2000,  # if "estimated adjustment 'a' is NA", increase n bootstraps 
         ci.conf = 0.95)

# summarize
cohens_d_influenced <- 
  data.frame(cohens_d = h5_obama_trump_influenced$t0,
             cohens_d_ci_lwr = h5_obama_trump_influenced$bounds[1],
             cohens_d_ci_upr = h5_obama_trump_influenced$bounds[2]) %>%
  round_df(2) %>%
  mutate(subset = "Influenced")

# combine and print
rbind(cohens_d_non_influenced, cohens_d_influenced) %>%
  select(subset, cohens_d, cohens_d_ci_lwr, cohens_d_ci_upr)

```

```{r}

# alt logistic approach
# weird results, but ive left it in so jamie can see.

h5_fit <-
  analysis_data %>%
  select(IA_AMP_effect_obama_trump_influenced, IA_AMP_effect_obama_trump_not_influenced, party) %>%
  gather(influence, IA_AMP_effect, c(IA_AMP_effect_obama_trump_influenced,
                                     IA_AMP_effect_obama_trump_not_influenced)) %>%
  mutate(party = dplyr::recode(party,
                               "republican" = 0,
                               "democrat" = 1),
         influence = dplyr::recode(influence,
                                   "AMP_effect_obama_trump_not_influenced" = "not_influenced",
                                   "AMP_effect_obama_trump_influenced" = "influenced"),
         influence = as.factor(influence)) %>%
  glm(party ~ IA_AMP_effect * influence,
      family = binomial(link = "logit"),
      data = .)

sjt.glm(h5_fit)

sjp.int(h5_fit, mdrt.values = "quart")

sjp.int(h5_fit, mdrt.values = "meansd")

sjp.int(h5_fit, mdrt.values = "minmax")


```
