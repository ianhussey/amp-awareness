---
title: "Meta analysis"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

```

```{r}

# dependencies
library(tidyverse)
library(lme4)
library(effects)
library(metafor)
library(patchwork)
library(ggExtra)
library(sjPlot)
library(kableExtra)
library(knitr)
library(patchwork)

# disable scientific notation
options(scipen = 999) 

# knitr output for html
options(knitr.table.format = "html")

# get data
data_participant_level <- 
  read.csv("../data/data_combined_participant_level.csv") %>%
  mutate(AMP_effect = AMP_effect*-1,
         IA_AMP_effect = IA_AMP_effect*-1,
         experiment = as.factor(experiment),
         abs_AMP_effect = abs(AMP_effect),
         abs_IA_AMP_effect = abs(IA_AMP_effect),
         abs_IA_AMP_effect_uninfluenced_trials = abs(IA_AMP_uninfluenced_effect), 
         abs_IA_AMP_effect_influenced_trials = abs(IA_AMP_influenced_effect))

data_trial_level_valence_ia_amp  <- 
  read.csv("../data/data_combined_trial_level.csv")  %>%
  mutate(influenced = as.logical(influenced)) %>%
  rownames_to_column(var = "unique_row_name") %>%
  group_by(experiment, IA_AMP_domain, unique_id, influenced, prime_type) %>%
  mutate(trial_number = row_number(),
         max_trials_per_block = max(trial_number)) %>%
  ungroup() %>%
  filter(IA_AMP_domain == "Valence")

```

# Total participants after exclusions

```{r}

data_participant_level %>%
  distinct(unique_id) %>%
  dplyr::count() %>%
  kable()

```

# Does influence rate predict the magnitude of (IA)AMP effects?

## Participant level

### IA-AMP effect ~ IA-AMP influence_rate

IA-AMP effect ~ IA-AMP influence rate

Absolute IA-AMP effects

```{r}

fit_participant_level_ia_amp <- 
  lmer(abs_IA_AMP_effect ~ influence_rate + (1 | experiment), 
       data = data_participant_level)

tab_model(fit_participant_level_ia_amp, 
          show.std = TRUE,
          col.order = c("est", "ci", "std.est", "std.ci", "p"),
          string.est = "B",
          string.ci = "CI",
          string.std = "Std.Beta",
          string.std_ci = "Std.Beta CI",
          emph.p = FALSE,
          ci.hyphen = ", ")

```

### AMP effect ~ IA-AMP influence rate

AMP effect ~ IA-AMP influence rate

Absolute AMP effects

```{r}

fit_participant_level_amp <- 
  lmer(abs_AMP_effect ~ influence_rate + (1 | experiment), 
       data = data_participant_level)

tab_model(fit_participant_level_amp, 
          show.std = TRUE,
          col.order = c("est", "ci", "std.est", "std.ci", "p"),
          string.est = "B",
          string.ci = "CI",
          string.std = "Std.Beta",
          string.std_ci = "Std.Beta CI",
          emph.p = FALSE,
          ci.hyphen = ", ")

```

### Combined plots

```{r fig.height=8.5, fig.width=6}

plot_ia_amp <- 
  data_participant_level %>%  
  mutate(IA_AMP_domain = fct_rev(IA_AMP_domain)) %>% 
  ggplot(aes(influence_rate, abs_IA_AMP_effect, color = experiment, linetype = IA_AMP_domain)) +
  geom_smooth(method = "lm", alpha = 0.0, fullrange = TRUE) +
  ylim(0,1) +
  xlim(0,1) + 
  theme_classic() +
  xlab("Awareness rate") +
  ylab("IA-AMP effect") +
  scale_color_viridis_d(begin = 0.1, end = 0.9) +
  guides(color = guide_legend(title = "Experiment"),
         linetype = guide_legend(title = "Domain"))


plot_amp <- 
  data_participant_level %>%
  mutate(AMP_domain = fct_rev(AMP_domain)) %>% 
  ggplot(aes(influence_rate, abs_AMP_effect, color = experiment, linetype = AMP_domain)) +
  geom_smooth(method = "lm", alpha = 0.0, fullrange = TRUE) +
  ylim(0,1) +
  xlim(0,1) + 
  theme_classic() +
  xlab("Awareness rate") +
  ylab("AMP effect") +
  scale_color_viridis_d(begin = 0.1, end = 0.9) +
  guides(color = guide_legend(title = "Experiment"),
         linetype = guide_legend(title = "Domain"))

plot_ia_amp / plot_amp

```

### Awareness rate

Combination analysis due to severe bimodality.

Mann et al. (2019) specifically argued that their modifications should reduce the bimodality of AMP effects, i.e., that there should be distributional differences between the two samples (IA-AMPs employing the standard stimuli and task format vs a Mann et all IA-AMP).

#### Visual inspection

```{r fig.height=2.5, fig.width=5}

data_IA_AMP_types <- data_participant_level %>%
  mutate(IA_AMP_type = ifelse(experiment == 6, "Mann et al. (2019) modifications", "Standard")) %>%
  select(IA_AMP_type, influence_rate)

plot_influence_rate <- 
  ggplot(data_IA_AMP_types, aes(influence_rate, fill = IA_AMP_type)) +
  geom_density(adjust = .5, alpha = 0.5) +
  theme_classic() +
  scale_fill_viridis_d(begin = 0.3, end = 0.7) +
  xlab("Awareness rate") +
  ylab("Distribution density") +
  guides(fill = guide_legend(title = "IA-AMP type")) + 
  theme(legend.position = c(0.8, 0.8))

plot_influence_rate

```

#### Test of unimodality

Hartigans' Dip Tests (H0 = unimodality)

##### All data 

```{r}

dip.test(data_IA_AMP_types %>% 
           pull(influence_rate)) 

```

##### Subset of standard (non Mann et al) IA-AMPs 

```{r}

dip.test(data_IA_AMP_types %>% 
           filter(IA_AMP_type == "Standard") %>% 
           pull(influence_rate)) 

```

##### Subset of Mann et al. IA-AMPs 

```{r}

dip.test(data_IA_AMP_types %>% 
           filter(IA_AMP_type == "Mann et al. (2019) modifications") %>% 
           pull(influence_rate)) 

```

#### Descriptive stats

```{r}

N <- nrow(data_participant_level)

data_participant_level %>%
  mutate(influence_rate_bins = ifelse(influence_rate <= .20, 1, 
                                           ifelse(influence_rate <= .40, 2, 
                                                  ifelse(influence_rate <= .60, 3, 
                                                         ifelse(influence_rate <= .80, 4, 
                                                                ifelse(influence_rate <= 1.00, 5, NA))))),
         influence_rate_bins = as.factor(influence_rate_bins)) %>%
  dplyr::count(influence_rate_bins) %>%
  mutate(percent = round(n/N, 2)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

data_participant_level %>%
  mutate(influence_rate_categories = ifelse(influence_rate <= .05, "almost none", 
                                            ifelse(influence_rate >= 0.95, "almost all", "some")),
         influence_rate_categories = as.factor(influence_rate_categories)) %>%
  dplyr::count(influence_rate_categories) %>%
  mutate(percent = round(n/N, 2)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

data_participant_level %>%
  summarize(median_influence_rate = median(influence_rate),
            mad_influence_rate = mad(influence_rate)) %>%
  mutate_if(is.numeric, round, digits = 2) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

## Trial level

Positive-negative IA-AMPs only (i.e., no Politics IA-AMP), as trial level data reveals the magnitude of the AMP effect but not the absolute magnitude. When there are meaningful individual differences between the positive and negative category (i.e., the Politics IA-AMP but not the positive-negative IA-AMP), the native trial level AMP effects between groups conceal the absolute magnitudes. As such, it is only meaningful to meta analyze the positive-negative IA-AMP effects.  

```{r fig.height=5, fig.width=6.5}

# fit model
if(file.exists("models/fit_trial_level.rds")){
  
  fit_trial_level <- read_rds("models/fit_trial_level.rds")
  
}else{
  
  fit_trial_level <- 
    glmer(rating ~ prime_type * influenced + (1 | experiment/unique_id),
          family = binomial(link = "logit"),
          data = data_trial_level_valence_ia_amp)
  
  write_rds(fit_trial_level, path = "models/fit_trial_level.rds", compress = "gz")
  
}

# estimates
tab_model(fit_trial_level, 
          show.std = TRUE,
          col.order = c("est", "ci", "std.est", "std.ci", "p"),
          ci.hyphen = ", ")

plot_model(fit_trial_level, type = "int")

# plot
predictions <- data_trial_level_valence_ia_amp %>%
  mutate(prob = predict(fit_trial_level, type = c("response")),
         `Influence of prime\non evaluation of target` = dplyr::recode(as.character(influenced), 
                                                                       "0" = "Non-influence aware trials",
                                                                       "1" = "Influence aware trials"),
         prime_type = fct_relevel(prime_type, "Negative", "Positive"))

ggplot(data = predictions, 
       aes(x = `Influence of prime\non evaluation of target`, 
           y = prob,
           fill = as.factor(prime_type),
           color = as.factor(prime_type))) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0),
                   adjust = 2,
                   alpha = .8) +
  geom_point(position = position_jitter(width = .15), 
             size = 0.25, 
             alpha = 0.8) +
  scale_colour_viridis_d(begin = 0.3, end = 0.7) +
  scale_fill_viridis_d(begin = 0.3, end = 0.7) +
  coord_flip() +
  theme_classic() +
  xlab("Influence-awareness of prime on evaluation of target") +
  ylab("Evaluation on IA-AMP") +
  scale_y_continuous(breaks = c(0, 0.25, 0.50, 0.75, 1.00), 
                     labels = c("0.00\n(Negative)", "0.25", "0.50", "0.75", "1.00\n(Positive)"), 
                     limits = c(0, 1)) + 
  labs(color = "Prime type") + 
  labs(name = "Prime type") +
  labs(fill = "Prime type")

```

# Session info

```{r}

sessionInfo()

```

