---
title: "Meta analysis"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

```

```{r}

# dependencies
library(tidyverse)
library(lme4)
library(effects)
library(metafor)
library(patchwork)
library(ggExtra)
library(sjPlot)
library(kableExtra)
library(knitr)
library(patchwork)

# function to round all numerics in a data frame
round_df <- function(df, n_digits = 3){
  # dependencies
  require(dplyr)
  
  df %>% mutate_if(is.numeric, round, digits = n_digits)
}

# disable scientific notation
options(scipen = 999) 

# knitr output for html
options(knitr.table.format = "html")

# get data
data_participant_level <- 
  read.csv("../data/data_combined_participant_level.csv") %>%
  mutate(AMP_effect = AMP_effect*-1,
         IA_AMP_effect = IA_AMP_effect*-1,
         experiment = as.factor(experiment),
         abs_AMP_effect = abs(AMP_effect),
         abs_IA_AMP_effect = abs(IA_AMP_effect),
         abs_IA_AMP_effect_uninfluenced_trials = abs(IA_AMP_uninfluenced_effect), 
         abs_IA_AMP_effect_influenced_trials = abs(IA_AMP_influenced_effect))

data_participant_level_valence_ia_amp <- 
  data_participant_level %>%
  filter(IA_AMP_domain == "Generic valence")

data_trial_level  <- 
  read.csv("../data/data_combined_trial_level.csv")  %>%
  mutate(influenced = as.logical(influenced)) %>%
  rownames_to_column(var = "unique_row_name") %>%
  group_by(experiment, IA_AMP_domain, unique_id, influenced, prime_type) %>%
  mutate(trial_number = row_number(),
         max_trials_per_block = max(trial_number)) %>%
  ungroup()

data_trial_level_valence_ia_amp <- 
  data_trial_level %>%
  filter(IA_AMP_domain == "Generic valence")

```

# Total participants after exclusions

```{r}

data_participant_level %>%
  distinct(unique_id) %>%
  dplyr::count() %>%
  kable()

```

# Does influence rate predict the magnitude of (IA)AMP effects?

## Participant level

### IA-AMP effect ~ IA-AMP influence_rate

IA-AMP effect ~ IA-AMP influence rate 

Absolute IA-AMP effects.

```{r}

# fit model corresponding to preregistered hypotheses
fit_1 <- lmer(abs_IA_AMP_effect ~ influence_rate + (1 | experiment), 
              data = data_participant_level)

tab_model(fit_1, 
          show.std = TRUE,
          col.order = c("est", "ci", "std.est", "std.ci", "p"),
          ci.hyphen = ", ")

```


### AMP effect ~ IA-AMP influence rate

AMP effect ~ IA-AMP influence rate

Absolute AMP effects.

```{r}

# fit model corresponding to preregistered hypotheses
fit_3 <- lmer(abs_AMP_effect ~ influence_rate + (1 | experiment), 
              data = data_participant_level)

tab_model(fit_3, 
          show.std = TRUE,
          col.order = c("est", "ci", "std.est", "std.ci", "p"),
          ci.hyphen = ", ")

```

### Combined plots

```{r fig.height=8.5, fig.width=6}

plot_ia_amp <- 
  data_participant_level %>%  
  mutate(IA_AMP_domain = fct_rev(ifelse(IA_AMP_domain == "Generic valence", "Valence", IA_AMP_domain))) %>% 
  ggplot(aes(influence_rate, abs_IA_AMP_effect, color = experiment, linetype = IA_AMP_domain)) +
  geom_smooth(method = "lm", alpha = 0.0, fullrange = TRUE) +
  ylim(0,1) +
  xlim(0,1) + 
  theme_classic() +
  xlab("Influence rate on IA-AMP") +
  ylab("Absolute IA-AMP effect") +
  scale_color_viridis_d(begin = 0.1, end = 0.9) +
  guides(color = guide_legend(title = "Experiment"),
         linetype = guide_legend(title = "Domain"))


plot_amp <- 
  data_participant_level %>%
  mutate(AMP_domain = fct_rev(ifelse(AMP_domain == "Generic valence", "Valence", AMP_domain))) %>%
  ggplot(aes(influence_rate, abs_AMP_effect, color = experiment, linetype = AMP_domain)) +
  geom_smooth(method = "lm", alpha = 0.0, fullrange = TRUE) +
  ylim(0,1) +
  xlim(0,1) + 
  theme_classic() +
  xlab("Influence rate on IA-AMP") +
  ylab("Absolute AMP effect") +
  scale_color_viridis_d(begin = 0.1, end = 0.9) +
  guides(color = guide_legend(title = "Experiment"),
         linetype = guide_legend(title = "Domain"))

plot_ia_amp / plot_amp

```



## Trial level

Positive-negative IA-AMPs only (i.e., no Politics IA-AMP), as trial level data reveals the magnitude of the AMP effect but not the absolute magnitude. When there are meaningful individual differences between the positive and negative category (i.e., the Politics IA-AMP but not the positive-negative IA-AMP), the native trial level AMP effects between groups conceal the absolute magnitudes. As such, it is only meaningful to meta analyze the positive-negative IA-AMP effects.  

```{r fig.height=5, fig.width=6.5}

# fit model
fit_2 <- glmer(rating ~ prime_type * influenced + (1 | experiment/unique_id),
               family = binomial(link = "logit"),
               data = data_trial_level_valence_ia_amp)

# estimates
tab_model(fit_2, 
          show.std = TRUE,
          col.order = c("est", "ci", "std.est", "std.ci", "p"),
          ci.hyphen = ", ")

plot_model(fit_2, type = "int")

# plot
predictions <- data_trial_level_valence_ia_amp %>%
  mutate(prob = predict(fit_2, type = c("response")),
         `Influence of prime\non evaluation of target` = dplyr::recode(as.character(influenced), 
                                                                       "0" = "Non-influence aware trials",
                                                                       "1" = "Influence aware trials"),
         prime_type = fct_relevel(prime_type, "Negative", "Positive"))

ggplot(data = predictions, 
       aes(x = `Influence of prime\non evaluation of target`, 
           y = prob,
           fill = as.factor(prime_type),
           color = as.factor(prime_type))) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0),
                   adjust = 2,
                   alpha = .8) +
  geom_point(position = position_jitter(width = .15), 
             size = 0.25, 
             alpha = 0.8) +
  scale_colour_viridis_d(begin = 0.3, end = 0.7) +
  scale_fill_viridis_d(begin = 0.3, end = 0.7) +
  coord_flip() +
  theme_classic() +
  xlab("Influence-awareness of prime on evaluation of target") +
  ylab("Evaluation on IA-AMP") +
  scale_y_continuous(breaks = c(0, 0.25, 0.50, 0.75, 1.00), 
                     labels = c("0.00\n(Negative)", "0.25", "0.50", "0.75", "1.00\n(Positive)"), 
                     limits = c(0, 1)) + 
  labs(color = "Prime type") + 
  labs(name = "Prime type") +
  labs(fill = "Prime type")

```

#### Reviewer requested: Compute effects at each level of the moderator 

##### Means & SDs of data

Estimated marginal means can be found in the above plot. SDs are a property of the observed data rather than the model predictions, but I also return them below. NB these therefore ignore the hierarchical structure in the data and should not be used for inference.

```{r}

data_descriptives <- data_trial_level %>%
  filter(IA_AMP_domain == "Generic valence") %>%
  group_by(influenced) %>%
  select(unique_id, prime_type, rating, influenced) %>%
  group_by(influenced, prime_type) %>%
  summarise(mean_rating = mean(rating),
            sd_rating = sd(rating)) %>%
  round_df(2)

data_descriptives %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

# IA-AMP influence rate

Combination analysis due to severe bimodality.

```{r fig.height=2.5, fig.width=5}

# Distribution
p4 <- ggplot(data_participant_level, aes(influence_rate, fill = "dummy")) +
  geom_density(adjust = .5) +
  theme_classic() +
  scale_fill_viridis_d(begin = 0.65) +
  xlab("Influence-awareness rate") +
  ylab("Distribution density") + 
  theme(legend.position = "none")

p4

save(p4, file = "../data/p4.RData")

```

```{r}

N <- nrow(data_participant_level)

data_participant_level %>%
  mutate(influence_rate_quintiles = ifelse(influence_rate <= .20, 1, 
                                           ifelse(influence_rate <= .40, 2, 
                                                  ifelse(influence_rate <= .60, 3, 
                                                         ifelse(influence_rate <= .80, 4, 
                                                                ifelse(influence_rate <= 1.00, 5, NA))))),
         influence_rate_quintiles = as.factor(influence_rate_quintiles)) %>%
  dplyr::count(influence_rate_quintiles) %>%
  mutate(percent = round(n/N, 2)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

data_participant_level %>%
  mutate(influence_rate_categories = ifelse(influence_rate <= .05, "almost none", 
                                            ifelse(influence_rate >= 0.95, "almost all", "some")),
         influence_rate_categories = as.factor(influence_rate_categories)) %>%
  dplyr::count(influence_rate_categories) %>%
  mutate(percent = round(n/N, 2)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

data_participant_level %>%
  summarize(median_influence_rate = median(influence_rate),
            mad_influence_rate = mad(influence_rate)) %>%
  round_df(2) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

# Combine plots

```{r fig.height=20, fig.width=7.15}

# # get plot from exp 4
# load("../Experiment 4/analysis/p1.RData")
# 
# p_combined <- p1 + p2 + p3 + p4 + plot_layout(ncol = 1)
# 
# p_combined
# 
# save(p_combined, file = "../data/p_combined.RData")

```

# Session info

```{r}

sessionInfo()

```

