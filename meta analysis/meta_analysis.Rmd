---
title: "Meta analysis"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

```

```{r}

# dependencies
library(tidyverse)
library(timesavers)
library(lme4)
library(effects)
library(metafor)
library(patchwork)
library(ggExtra)
library(sjPlot)
library(kableExtra)
library(knitr)
library(patchwork)
library(ggridges)

# source for raincloud plots
source("geom_flat_violin.R")

# disable scientific notation
options(scipen = 999) 

# knitr output for html
options(knitr.table.format = "html")

# get data
data_participant_level <- 
  read.csv("data/data_combined_participant_level.csv") %>%
  mutate(AMP_effect = AMP_effect*-1,
         IA_AMP_effect = IA_AMP_effect*-1,
         experiment = as.factor(experiment),
         abs_AMP_effect = abs(AMP_effect),
         abs_IA_AMP_effect = abs(IA_AMP_effect),
         abs_IA_AMP_effect_uninfluenced_trials = abs(IA_AMP_uninfluenced_effect), 
         abs_IA_AMP_effect_influenced_trials = abs(IA_AMP_influenced_effect))

data_participant_level_valence_ia_amp <- 
  data_participant_level %>%
  filter(IA_AMP_domain == "Generic valence")

data_trial_level  <- 
  read.csv("data/data_combined_trial_level.csv")  %>%
  mutate(influenced = as.logical(influenced)) 

data_trial_level_valence_ia_amp <- 
  data_trial_level %>%
  filter(IA_AMP_domain == "Generic valence")

```

# Total participants after exclusions

```{r}

combined_participant_level_data %>%
  distinct(unique_id) %>%
  dplyr::count() %>%
  kable()

```

# Does influence rate predict the magnitude of (IA)AMP effects?

## IA-AMP effect ~ IA-AMP influence_rate

### Participant level

IA-AMP effect ~ IA-AMP influence rate 

Absolute IA-AMP effects.

```{r}

# fit model corrisponding to preregistered hypotheses
fit_1 <- lmer(abs_IA_AMP_effect ~ influence_rate + (1 | experiment/IA_AMP_domain), 
              data = data_participant_level)

tab_model(fit_1, show.std = TRUE)

# plot_model(fit_1, 
#            type = "pred", 
#            show.data = TRUE,
#            jitter = 0.005)$influence_rate + 
#   theme_classic() +
#   xlab("IA-AMP influence rate") +
#   ylab("Absolute IA-AMP effect") +
#   ggtitle("Relationahip between influence rate and valence IA-AMP effect") 

data_participant_level %>%
  mutate(label = paste("Exp", experiment, IA_AMP_domain)) %>%
  ggplot(aes(influence_rate, abs_IA_AMP_effect, color = label)) +
  geom_jitter(width = 0.005, alpha = 0.3) +
  geom_smooth(method = "lm", alpha = 0.0, fullrange = TRUE) +
  ylim(0,1) +
  xlim(0,1) + 
  theme_classic() +
  xlab("Influence rate") +
  ylab("Absolute magnitude of\nIA-AMP effect") +
  ggtitle("Relationship between influence rate and IA-AMP effect") +
  scale_color_viridis_d(begin = 0.3, end = 0.7)

```

### Trial level

Positive-negative IA-AMPs only (i.e., no Politics IA-AMP), as trial level data reveals the magnitude of the AMP effect but not the absolute magnitude. When there are meaningful individual differences between the positive and negative category (i.e., the Politics IA-AMP but not the positive-negative IA-AMP), the native trial level AMP effects between groups conceal the absolute magnitudes. As such, it is only meaningful to meta analyze the positive-negative IA-AMP effects.  

```{r fig.height=5, fig.width=6.5}

# fit model
fit_2 <- glmer(rating ~ prime_type * influenced + (1 | experiment/unique_id),
               family = binomial(link = "logit"),
               data = data_trial_level_valence_ia_amp)

# estimates
tab_model(fit_2)

# plot
predictions <- data_trial_level_valence_ia_amp %>%
  mutate(prob = predict(model_2, type = c("response")),
         `Influence of prime\non evaluation of target` = dplyr::recode(as.character(influenced), 
                                                                       "0" = "Non-influence aware trials",
                                                                       "1" = "Influence aware trials"),
         prime_type = fct_relevel(prime_type, "Negative", "Positive"))

ggplot(data = predictions, 
       aes(x = `Influence of prime\non evaluation of target`, 
           y = prob,
           fill = as.factor(prime_type),
           color = as.factor(prime_type))) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0),
                   adjust = 2,
                   alpha = .8) +
  geom_point(position = position_jitter(width = .15), 
             size = 0.25, 
             alpha = 0.8) +
  scale_colour_viridis_d(begin = 0.3, end = 0.7) +
  scale_fill_viridis_d(begin = 0.3, end = 0.7) +
  coord_flip() +
  theme_classic() +
  xlab("Influence-awareness of prime on evaluation of target") +
  ylab("Evaluation on IA-AMP") +
  scale_y_continuous(breaks = c(0, 0.25, 0.50, 0.75, 1.00), 
                     labels = c("0.00\n(Negative)", "0.25", "0.50", "0.75", "1.00\n(Positive)"), 
                     limits = c(0, 1)) + 
  labs(color = "Prime type") + 
  labs(name = "Prime type") +
  labs(fill = "Prime type")

```

#### Reviewer requested: Compute effects at each level of the moderator including means and SDs. 

Estimated marginal means can be found in the above plot. SDs are a property of the observed data rather than the model predictions, but I also return them below. NB these therefore ignore the hierarchical structure in the data.


CHANGE TO MARGINAL MEANS PREDICTIONS?


```{r}

data_descriptives <- combined_trial_level_data %>%
  filter(IA_AMP_domain == "Generic valence") %>%
  group_by(influenced) %>%
  select(unique_id, prime_type, rating, influenced) %>%
  group_by(prime_type, influenced) %>%
  summarise(mean_rating = mean(rating),
            sd_rating = sd(rating)) %>%
  round_df(2)

data_descriptives %>%
  kable()

```



```{r}

# predictions based on model
predictions <- 
  data.frame(prime_type = c("Positive", 
                            "Positive", 
                            "Negative", 
                            "Negative"), 
             influenced = c(TRUE, 
                            FALSE, 
                            TRUE,
                            FALSE)) %>%
  add_ci(., 
         fit_2, 
         alpha = 0.05, 
         #type = "parametric",
         includeRanef = FALSE) %>%
  rename(abs_AMP_effect = pred,
         lower = LCB0.025,
         upper = UCB0.975) %>%
  select(awareness, abs_AMP_effect, lower, upper) %>%
  round_df(2)

predictions %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

## AMP effect ~ IA-AMP influence rate

AMP effect ~ IA-AMP influence rate

Absolute AMP effects.

```{r}

# fit model corrisponding to preregistered hypotheses
fit_2 <- lmer(abs_AMP_effect ~ influence_rate + (1 | experiment/IA_AMP_domain), 
              data = data_participant_level)

tab_model(fit_2, show.std = TRUE)

# plot_model(fit_2, 
#            type = "pred", 
#            show.data = TRUE,
#            jitter = 0.005)$influence_rate + 
#   theme_classic() +
#   xlab("IA-AMP influence rate") +
#   ylab("Absolute IA-AMP effect") +
#   ggtitle("Relationahip between influence rate and valence IA-AMP effect") 

data_participant_level %>%
  mutate(label = paste("Exp", experiment, IA_AMP_domain)) %>%
  filter(!experiment %in% c(1, 4)) %>%
  ggplot(aes(influence_rate, abs_AMP_effect, color = label)) +
  geom_jitter(width = 0.005, alpha = 0.3) +
  geom_smooth(method = "lm", alpha = 0.0, fullrange = TRUE) +
  ylim(0,1) +
  xlim(0,1) + 
  theme_classic() +
  xlab("Influence rate") +
  ylab("Absolute magnitude of\nAMP effect") +
  ggtitle("Relationship between influence rate and AMP effect") +
  scale_color_viridis_d(begin = 0.3, end = 0.7)

```

# Native magnitue of (IA)AMP effects

At participant level 

## AMP

AMP effect ~ 1

**Native** AMP effects. Generic Valence AMP only.



## IA-AMP

IA-AMP effect ~ 1

**Native** IA-AMP effects. Generic Valence AMP only.



# IA-AMP influence rate

Combination analysis due to severe bimodality.

Participant level

## Distribution

```{r fig.height=5, fig.width=5}

# Distribution
p4 <- ggplot(combined_participant_level_data, aes(influence_rate, fill = "dummy")) +
  geom_density(adjust = .4) +
  theme_classic() +
  scale_fill_viridis_d(begin = 0.65) +
  xlab("Influence-awareness rate") +
  ylab("Distribution density") + 
  theme(legend.position = "none")

p4

save(p4, file = "data/p4.RData")

```

```{r}

N <- nrow(combined_participant_level_data)

combined_participant_level_data %>%
  mutate(influence_rate_quintiles = ifelse(influence_rate <= .20, 1, 
                                           ifelse(influence_rate <= .40, 2, 
                                                  ifelse(influence_rate <= .60, 3, 
                                                         ifelse(influence_rate <= .80, 4, 
                                                                ifelse(influence_rate <= 1.00, 5, NA))))),
         influence_rate_quintiles = as.factor(influence_rate_quintiles)) %>%
  dplyr::count(influence_rate_quintiles) %>%
  mutate(percent = round(n/N, 2)) %>%
  kable()

combined_participant_level_data %>%
  mutate(influence_rate_categories = ifelse(influence_rate <= .05, "almost none", 
                                            ifelse(influence_rate >= 0.95, "almost all", "some")),
         influence_rate_categories = as.factor(influence_rate_categories)) %>%
  dplyr::count(influence_rate_categories) %>%
  mutate(percent = round(n/N, 2)) %>%
  kable()

combined_participant_level_data %>%
  summarize(median_influence_rate = median(influence_rate),
            mad_influence_rate = mad(influence_rate)) %>%
  kable()

```

# Combine plots

```{r fig.height=20, fig.width=7.15}

# get plot from exp 4
load("../Experiment 4/analysis/p1.RData")

p_combined <- p1 + p2 + p3 + p4 + plot_layout(ncol = 1)

p_combined

save(p_combined, file = "data/p_combined.RData")

```


