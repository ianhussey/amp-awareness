---
title: "Meta analysis"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

# Overview 

Meta analyses of pos-neg IA-AMP, which was present in all studies. 

- Analysis of the IA-AMP effect (rating ~ prime_type)
- Analysis of the IA-AMP effect being moderated by influence (rating ~ prime_type*influence)

Meta analyses of both the participant level AMP effects and the trial type level data are included given that both types of analyses were done at the experiment level. However, analyses of trial level data given more precise estimations and are used for hypothesis tests.

```{r, include=FALSE}

knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

```

```{r}

# dependencies
library(tidyverse)
library(timesavers)
library(lme4)
library(effects)
library(metafor)
library(patchwork)
library(lme4)

# source for raincloud plots
source("../geom_flat_violin.R")

# disable scientific notation
options(scipen = 999) 

# knitr output for html
options(knitr.table.format = "html")


# custom functions --------------------

# fit models to individual experiments and extract an effect of interest
fit_lm_model_and_extract_effect <- function(data, experiment_n, formula, effect) {
  require(tidyverse)
  
  fit <- data %>%
    filter(experiment == experiment_n) %>%
    lm(formula = formula, 
       data = .)
  
  results <- 
    summary(fit)$coefficients %>%
    as.data.frame() %>%
    rownames_to_column(var = "Effect") %>%
    filter(Effect == effect) %>%
    mutate(Experiment = experiment_n,
           yi = Estimate,       # effect size
           vi = `Std. Error`^2) # convert SE to variance
  
  return(results)
}

# meta analyse and plot
meta_analysis_workflow <- function(data, effect_size_label, reference_line, exp_estimates = FALSE) {
  require(timesavers)
  require(tidyverse)
  require(metafor)
  
  # fit random effects model 
  fitted_model <- 
    rma(yi, vi,
        data = data,
        slab = Experiment)
  
  # model predictions
  meta_analysis_results <-
    predict(fitted_model, digits = 5) %>%
    as.data.frame() %>%
    gather() %>%
    round_df(3) %>%
    dplyr::rename(metric = key,
                  estimate = value) %>%
    mutate(metric = dplyr::recode(metric,
                                  "pred" = paste0("Meta analysed", effect_size_label),
                                  "ci.lb" = "95% CI lower",
                                  "ci.ub" = "95% CI upper",
                                  "cr.lb" = "95% CR lower",
                                  "cr.ub" = "95% CR upper"))
  
  # conditionally exponentiate estimates if converting log odds to odds ratios
  if(exp_estimates == TRUE) {
    meta_analysis_results <- meta_analysis_results %>%
      mutate(estimate = round(exp(estimate), 3))
  }
  
  # summarize results
  meta_analysis_results_text <- 
    paste0("k = ", fitted_model$k, ", ", 
           effect_size_label, " = ", meta_analysis_results$estimate[1],
           # dynamic indexing of some values as different models return variables in different locations, but relative location is reliable
           ", 95% CI [", meta_analysis_results$estimate[length(meta_analysis_results$estimate)-3],  
           ", ",         meta_analysis_results$estimate[length(meta_analysis_results$estimate)-2], 
           "], 95% CR [", meta_analysis_results$estimate[length(meta_analysis_results$estimate)-1], 
           ", ",         meta_analysis_results$estimate[length(meta_analysis_results$estimate)], 
           "], p = ",     signif(2*pnorm(-abs(fitted_model$zval)), digits = 1))  # p value from z score

  heterogeneity_test_results_text <- 
    paste0("Q(df = ",    fitted_model$k - 1, ") = ", round(fitted_model$QE, 2), 
           ", p = ",     ifelse(fitted_model$pval < 0.001, "< .001", as.character(round(fitted_model$pval, 3))),
           ", tau^2 = ", round(fitted_model$tau2, 2), 
           ", I^2 = ",   round(fitted_model$I2, 2),
           ", H^2 = ",   round(fitted_model$H2, 2))
  
  # forest plot
  if (exp_estimates == TRUE) {
    transformation <- exp
  } else { 
    transformation <- NULL
  }
  
  forest_plot <- forest(fitted_model,
                        xlab = effect_size_label,
                        addcred = TRUE,
                        atransf = transformation,
                        refline = reference_line)
  
  return(list(fitted_model = fitted_model, 
              meta_analysis_results = meta_analysis_results,
              meta_analysis_results_text = meta_analysis_results_text,
              heterogeneity_test_results_text = heterogeneity_test_results_text,
              forest_plot = forest_plot))
}


# get data

combined_participant_level_data <- read.csv("data/combined_participant_level_data.csv")
combined_trial_level_data <- read.csv("data/combined_trial_level_data.csv")

```

# Correlation between online and offline influence rates

change to meta

```{r}

# cor.test(combined_participant_level_data$influence_general, combined_participant_level_data$influence_rate)
# 
# ggplot(combined_participant_level_data, aes(as.integer(as.character(influence_general)), influence_rate)) +
#   geom_jitter(alpha = 0.3) +
#   geom_smooth(method = "lm")

fit <- lmer(influence_rate ~ influence_general + (1 | experiment), 
            data = combined_participant_level_data)

library(sjPlot)

plot_model(fit, type = "pred", show.data = TRUE)
tab_model(fit, show.std = TRUE, emph.p = FALSE)

```

# AMPs

## AMP effect ~ influence 

should change this to multivariate meta and take amp type into account

```{r}

reshaped_data <- combined_participant_level_data %>%
  dplyr::select(unique_id, experiment, influence_rate, AMP_effect_positive_negative, AMP_effect_obama_trump) %>%
  gather(AMP_type, AMP_effect, c("AMP_effect_positive_negative", "AMP_effect_obama_trump")) %>%
  na.omit

formula <- as.formula("AMP_effect ~ influence_rate")
effect  <- "influence_rate"

# apply models to individual experiments, extract results for key effect
results_for_meta_analysis_amp <- rbind(
  fit_lm_model_and_extract_effect(data = reshaped_data, experiment_n = 2, formula = formula, effect = effect),
  fit_lm_model_and_extract_effect(data = reshaped_data, experiment_n = 3, formula = formula, effect = effect),
  fit_lm_model_and_extract_effect(data = reshaped_data, experiment_n = 5, formula = formula, effect = effect)
)

# meta analyse results
meta_results_amp <- meta_analysis_workflow(data              = results_for_meta_analysis_amp,
                                           effect_size_label = "Beta",
                                           reference_line    = 0)

```

- Meta analysis: `r meta_results_amp$meta_analysis_results_text`
- Heterogeneity tests: `r meta_results_amp$heterogeneity_test_results_text`

NEED TO CHANGE THE ABOVE THREE LEVEL META, TAKING DOMAIN INTO ACCOUNT.

#### Plot raw data

```{r}

# library(lme4)
# library(sjPlot)
# 
# combined_trial_level_data <- combined_trial_level_data %>%
#   mutate(influenced_inverted = abs(influenced - 1))
# 
# summary <- combined_trial_level_data %>%
#   group_by(experiment, unique_id) %>%
#   dplyr::summarize(perc_influenced = mean(influenced)) %>%
#   ungroup()
# 
# ggplot(summary, aes(perc_influenced, group = as.factor(experiment), fill = as.factor(experiment))) +
#   geom_density(alpha = 0.4, adjust = 0.8) +
#   scale_fill_viridis_d()


library(ggExtra)

p <- ggplot(reshaped_data, 
            aes(influence_rate, abs(AMP_effect))) +
  geom_point(alpha = 0.3, position = position_jitter()) +
  geom_smooth(method = "lm") +
  scale_color_viridis_d(end = 0.8) +
  theme_classic()

p2 <- ggMarginal(p, 
                 type = "histogram", 
                 margins = "both", 
                 size = 3)

```

```{r fig.height=5, fig.width=5}

grid::grid.newpage()
grid::grid.draw(p2)

```

# IA-AMP

## Participant level analyses

### IA-AMP effect

```{r}

formula <- as.formula("IA_AMP_effect_positive_negative ~ 1")
effect  <- "(Intercept)"

# apply models to individual experiments, extract results for key effect
results_for_meta_analysis_1 <- rbind(
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, 
                                  experiment_n = 1, 
                                  formula = formula, 
                                  effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, 
                                  experiment_n = 2, 
                                  formula = formula, 
                                  effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, 
                                  experiment_n = 3, 
                                  formula = formula, 
                                  effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, 
                                  experiment_n = 4, 
                                  formula = formula, 
                                  effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, 
                                  experiment_n = 5, 
                                  formula = formula, 
                                  effect = effect)
)

# meta analyse results
meta_results_1 <- meta_analysis_workflow(data              = results_for_meta_analysis_1, 
                                         effect_size_label = "Beta",
                                         reference_line    = 0) 

```

### IA-AMP influence rate

```{r}

formula <- as.formula("influence_rate ~ 1")
effect  <- "(Intercept)"

# apply models to individual experiments, extract results for key effect
results_for_meta_analysis_inf <- rbind(
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, 
                                  experiment_n = 1, 
                                  formula = formula, 
                                  effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, 
                                  experiment_n = 2, 
                                  formula = formula, 
                                  effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, 
                                  experiment_n = 3, 
                                  formula = formula, 
                                  effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, 
                                  experiment_n = 4, 
                                  formula = formula, 
                                  effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, 
                                  experiment_n = 5, 
                                  formula = formula, 
                                  effect = effect)
)

# meta analyse results
meta_results_inf <- meta_analysis_workflow(data              = results_for_meta_analysis_inf, 
                                           effect_size_label = "Beta",
                                           reference_line    = 0) 

```

- Meta analysis: `r meta_results_1$meta_analysis_results_text`
- Heterogeneity tests: `r meta_results_1$heterogeneity_test_results_text`

### IA-AMP effect ~ influence 

```{r}

formula <- as.formula("IA_AMP_effect_positive_negative ~ influence_rate")
effect  <- "influence_rate"

# apply models to individual experiments, extract results for key effect
results_for_meta_analysis_2 <- rbind(
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, experiment_n = 1, formula = formula, effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, experiment_n = 2, formula = formula, effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, experiment_n = 3, formula = formula, effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, experiment_n = 4, formula = formula, effect = effect),
  fit_lm_model_and_extract_effect(data = combined_participant_level_data, experiment_n = 5, formula = formula, effect = effect)
)

# meta analyse results
meta_results_2 <- meta_analysis_workflow(data              = results_for_meta_analysis_2, 
                                         effect_size_label = "Beta",
                                         reference_line    = 0)

```

- Meta analysis: `r meta_results_2$meta_analysis_results_text`
- Heterogeneity tests: `r meta_results_2$heterogeneity_test_results_text`

#### Plot raw data

```{r}

# library(lme4)
# library(sjPlot)
# 
# combined_trial_level_data <- combined_trial_level_data %>%
#   mutate(influenced_inverted = abs(influenced - 1))
# 
# summary <- combined_trial_level_data %>%
#   group_by(experiment, unique_id) %>%
#   dplyr::summarize(perc_influenced = mean(influenced)) %>%
#   ungroup()
# 
# ggplot(summary, aes(perc_influenced, group = as.factor(experiment), fill = as.factor(experiment))) +
#   geom_density(alpha = 0.4, adjust = 0.8) +
#   scale_fill_viridis_d()


library(ggExtra)

p <- ggplot(combined_participant_level_data, 
            aes(influence_rate, abs(IA_AMP_effect_positive_negative))) +
  geom_point(alpha = 0.3, position = position_jitter()) +
  geom_smooth(method = "lm") +
  scale_color_viridis_d(end = 0.8) +
  theme_classic()

p2 <- ggMarginal(p, 
                 type = "histogram", 
                 margins = "both", 
                 size = 3)

```

```{r fig.height=5, fig.width=5}

grid::grid.newpage()
grid::grid.draw(p2)

```

## Trial level analyses

### IA-AMP effect

```{r}

formula <- as.formula("rating ~ prime_type + (1 | unique_id)")
effect  <- "prime_typePositive"

# fit models to individual experiments and extract an effect of interest
fit_glmer_model_and_extract_effect <- function(data, experiment_n, formula, effect) {
  require(tidyverse)
  
  fit <- data %>%
    filter(experiment == experiment_n) %>%
    glmer(formula = formula, 
          family = binomial(link = "logit"),
          data = .)
  
  results <- 
    summary(fit)$coefficients %>%
    as.data.frame() %>%
    rownames_to_column(var = "Effect") %>%
    filter(Effect == effect) %>%
    mutate(Experiment = experiment_n,
           yi = Estimate,       # effect size
           vi = `Std. Error`^2) # convert SE to variance
  
  return(results)
}

# apply models to individual experiments, extract results for key effect
results_for_meta_analysis_3 <- rbind(
  fit_glmer_model_and_extract_effect(data = combined_trial_level_data, 
                                     experiment_n = 1, 
                                     formula = formula, 
                                     effect = effect),
  fit_glmer_model_and_extract_effect(data = combined_trial_level_data, 
                                     experiment_n = 2, 
                                     formula = formula, 
                                     effect = effect),
  fit_glmer_model_and_extract_effect(data = combined_trial_level_data, 
                                     experiment_n = 3, 
                                     formula = formula, 
                                     effect = effect),
  fit_glmer_model_and_extract_effect(data = combined_trial_level_data, 
                                     experiment_n = 4, 
                                     formula = formula, 
                                     effect = effect),
  fit_glmer_model_and_extract_effect(data = combined_trial_level_data, 
                                     experiment_n = 5, 
                                     formula = formula, 
                                     effect = effect)
)

# meta analyse results
meta_results_3 <- meta_analysis_workflow(data              = results_for_meta_analysis_3, 
                                         effect_size_label = "OR",
                                         reference_line    = 1, 
                                         exp_estimates     = TRUE) # exponentiate log odds to odds ratios

```

- N participants = `r nrow(combined_participant_level_data)`
- N IA-AMP trials = `r nrow(combined_trial_level_data)`
- Meta analysis: `r meta_results_3$meta_analysis_results_text`
- Heterogeneity tests: `r meta_results_3$heterogeneity_test_results_text`

### IA-AMP influence rate

xxx

### IA-AMP effect ~ influence

```{r}

formula <- as.formula("rating ~ prime_type * influenced + (1 | unique_id)")
effect  <- "prime_typePositive:influenced"

# apply models to individual experiments, extract results for key effect
results_for_meta_analysis_4 <- rbind(
  fit_glmer_model_and_extract_effect(data = combined_trial_level_data, 
                                     experiment_n = 1, 
                                     formula = formula, 
                                     effect = effect),
  fit_glmer_model_and_extract_effect(data = combined_trial_level_data, 
                                     experiment_n = 2, 
                                     formula = formula, 
                                     effect = effect),
  fit_glmer_model_and_extract_effect(data = combined_trial_level_data, 
                                     experiment_n = 3, 
                                     formula = formula, 
                                     effect = effect),
  fit_glmer_model_and_extract_effect(data = combined_trial_level_data, 
                                     experiment_n = 4, 
                                     formula = formula, 
                                     effect = effect),
  fit_glmer_model_and_extract_effect(data = combined_trial_level_data, 
                                     experiment_n = 5, 
                                     formula = formula, 
                                     effect = effect)
)

# meta analyse results
meta_results_4 <- meta_analysis_workflow(data              = results_for_meta_analysis_4, 
                                         effect_size_label = "OR",
                                         reference_line    = NULL, 
                                         exp_estimates     = TRUE) # exponentiate log odds to odds ratios

```

- N participants = `r nrow(combined_participant_level_data)`
- N IA-AMP trials = `r nrow(combined_trial_level_data)`
- Meta analysis: `r meta_results_4$meta_analysis_results_text`
- Heterogeneity tests: `r meta_results_4$heterogeneity_test_results_text`

#### Plot meta analysed interaction

```{r fig.height=6, fig.width=4.5}

# fit combined model
model_combined <- glmer(rating ~ prime_type * influenced + (1 | unique_id) + (1 | experiment), 
                        family = binomial(link = "logit"),
                        data = combined_trial_level_data)

# predictions
model_combined_predicted_effects <- 
  as.data.frame(effect("prime_type:influenced", model_combined, xlevels = 50)) %>%
  round_df(2) %>%
  mutate(prime_type = fct_relevel(prime_type, "Negative", "Positive"))

# Plot 1 -  quantiles (10ths) of interaction effect 
p1 <- 
  ggplot(data = model_combined_predicted_effects,
         aes(x = prime_type, y = fit, colour = influenced, group = influenced)) +
  geom_line() +
  ylab("Mean evaluation on IA-AMP") +
  xlab("Prime type") +
  #scale_y_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  scale_colour_viridis_c(direction = -1) +
  theme_classic() + 
  labs(colour = "Proportion of\ninfluenced trials") +
  scale_y_continuous(breaks = c(0, 0.25, 0.50, 0.75, 1.00), 
                     labels = c("(Negative) 0.00", "0.25", "0.50", "0.75", "(Positive) 1.00"), 
                     limits = c(0, 1))


# Plot 2 - differences between influenced and non influenced trials

## add these probabilities back to the original data frame (omitting missing values) 
predictions <- combined_trial_level_data %>%
  dplyr::select(prime_type, influenced, unique_id,  experiment) %>%
  na.omit %>%
  mutate(prob = predict(model_combined, type = c("response")),
         `Influence of prime\non evaluation of target` = dplyr::recode(influenced, 
                                                                       "0" = "Uninfluenced trials",
                                                                       "1" = "Influenced trials"),
         prime_type = fct_relevel(prime_type, "Negative", "Positive"))

# plot
p2 <- 
  ggplot(data = predictions, 
         aes(x = as.factor(prime_type), 
             y = prob,
             fill = `Influence of prime\non evaluation of target`,
             color = `Influence of prime\non evaluation of target`)) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0),
                   adjust = 2,
                   alpha = .8) +
  geom_point(position = position_jitter(width = .15), 
             size = 0.25, 
             alpha = 0.8) +
  scale_colour_viridis_d(begin = 0.3, end = 0.7) +
  scale_fill_viridis_d(begin = 0.3, end = 0.7) +
  coord_flip() +
  theme_classic() +
  xlab("Prime type") +
  ylab("Evaluation on IA-AMP") +
  scale_y_continuous(breaks = c(0, 0.25, 0.50, 0.75, 1.00), 
                     labels = c("0.00\n(Negative)", "0.25", "0.50", "0.75", "1.00\n(Positive)"), 
                     limits = c(0, 1))

# combined plots
p1 + p2 + plot_layout(ncol = 1)

```

